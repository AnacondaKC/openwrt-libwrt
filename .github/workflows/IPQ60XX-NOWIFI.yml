# ====================================================================================
#  æœ€ç»ˆå®Œç¾ç‰ˆ OpenWrt ç¼–è¯‘æµç¨‹ (v2 - 2025-06-28)
#  å·²æ ¹æ®ä½ çš„æ–°æ–‡ä»¶å‘½åè§„åˆ™ï¼Œæ›´æ–°äº†è‡ªå®šä¹‰æ–‡ä»¶è·¯å¾„ã€‚
# ====================================================================================
name: Build OpenWrt for IPQ60XX-NOWIFI

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  # schedule:
  #   - cron: '0 19 * * *' # å¯æ ¹æ®éœ€è¦å–æ¶ˆæ³¨é‡Šä»¥å¯ç”¨å®šæ—¶ç¼–è¯‘

env:
  # æºç ä¿¡æ¯
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: k6.12-nss

  # é…ç½®æ–‡ä»¶ä¸è‡ªå®šä¹‰æ–‡ä»¶è·¯å¾„ (å·²æ›´æ–°ä¸ºä½ çš„æ–°æ–‡ä»¶å)
  CONFIG_FILE: configs/ipq60xx-nowifi.config
  CUSTOM_FEEDS_CONF: feeds/IPQ60XX-NOWIFI-feeds.txt
  INIT_SETTINGS_SCRIPT: scripts/IPQ60XX-NOWIFI-settings.sh

  # ç¼–è¯‘å’Œå‘å¸ƒé€‰é¡¹
  CACHE_TOOLCHAIN: true
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: IPQ60XX-NOWIFI
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: 1. ç¯å¢ƒä¸ç©ºé—´å‡†å¤‡ (Initialization & Maximize Space)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi $(docker images -q) >/dev/null 2>&1
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
        sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* >/dev/null 2>&1
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL https://git.io/depends-ubuntu-2204)
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get -y clean
        sudo timedatectl set-timezone "$TZ"

    - name: 2. æ‰©å±•ç£ç›˜ç©ºé—´ (Combine Disks)
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        root-reserve-mb: 1024

    - name: 3. æ£€å‡ºå·¥ä½œæµä»“åº“ (Checkout Workflow Repo)
      uses: actions/checkout@main

    - name: 4. å…‹éš†OpenWrtæºç  (Clone Source Code)
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        echo "OPENWRT_PATH=$PWD/openwrt" >> $GITHUB_ENV
        cd openwrt
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV

    - name: 5. åŠ è½½è‡ªå®šä¹‰å†…å®¹å¹¶ç”Ÿæˆæœ€ç»ˆ.config (Load Custom Feeds, Scripts & Config)
      run: |
        # å°†è‡ªå®šä¹‰æºè¿½åŠ åˆ° feeds é…ç½®æ–‡ä»¶
        if [ -f "$CUSTOM_FEEDS_CONF" ]; then
          cat $CUSTOM_FEEDS_CONF >> ${{ env.OPENWRT_PATH }}/feeds.conf.default
          echo "è‡ªå®šä¹‰ Feeds å·²åŠ è½½ã€‚"
        fi

        # å°†åˆå§‹åŒ–è„šæœ¬å¤åˆ¶åˆ° uci-defaults ç›®å½•
        if [ -f "$INIT_SETTINGS_SCRIPT" ]; then
          mkdir -p ${{ env.OPENWRT_PATH }}/files/etc/uci-defaults
          cp $INIT_SETTINGS_SCRIPT ${{ env.OPENWRT_PATH }}/files/etc/uci-defaults/99-init-settings
          echo "åˆå§‹åŒ–è„šæœ¬å·²åŠ è½½ã€‚"
        fi
        
        # åŠ è½½ä½ çš„æ ¸å¿ƒç¼–è¯‘é…ç½®
        cp $CONFIG_FILE ${{ env.OPENWRT_PATH }}/.config
        
        # æ›´æ–°å¹¶å®‰è£…æ‰€æœ‰ feeds (åŒ…æ‹¬è‡ªå®šä¹‰çš„)
        cd ${{ env.OPENWRT_PATH }}
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # ç”Ÿæˆæœ€ç»ˆçš„å®Œæ•´ .config
        make defconfig

    - name: 6. ç”Ÿæˆç¯å¢ƒå˜é‡ (Generate Variables)
      run: |
        cd ${{ env.OPENWRT_PATH }}
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F'"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F'"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        CONFIG_HASH=$(sha256sum .config | awk '{print $1}')
        echo "CONFIG_HASH=$CONFIG_HASH" >> $GITHUB_ENV

    - name: 7. ç¼“å­˜å·¥å…·é“¾ (Cache Toolchain)
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.CONFIG_HASH }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: 8. ä¸‹è½½DLè½¯ä»¶åŒ… (Download DL Package)
      run: |
        cd ${{ env.OPENWRT_PATH }}
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: 9. å¼€å§‹ç¼–è¯‘å›ºä»¶ (Compile Firmware)
      id: compile
      run: |
        cd ${{ env.OPENWRT_PATH }}
        echo "å¼€å§‹ $(nproc) çº¿ç¨‹ç¼–è¯‘..."
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: 10. æ•´ç†æ–‡ä»¶ç”¨äºå‘å¸ƒ (Organize Files for Release)
      if: steps.compile.outputs.status == 'success'
      run: |
        FIRMWARE_DIR="${{ env.OPENWRT_PATH }}/bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}"
        echo "FIRMWARE_PATH=$FIRMWARE_DIR" >> $GITHUB_ENV
        cd $FIRMWARE_DIR
        cp ${{ env.OPENWRT_PATH }}/.config build.config
        rm -rf packages feeds.buildinfo version.buildinfo sha256sums

    - name: 11. å‘å¸ƒå›ºä»¶åˆ°Release (Upload Firmware To Release)
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - å¹³å°: `${{ env.FIRMWARE_TAG }}`
          - å†…æ ¸: 6.6 (åŸºäºLiBwrt)
          - ç‰¹æ€§: æ— WIFI, æœ‰çº¿NSSç¡¬ä»¶åŠ é€Ÿ
          - é»˜è®¤åœ°å€ä¸å¯†ç ç­‰ç”± `init-settings.sh` è„šæœ¬å®šä¹‰
          ### ğŸ§Š æºç ä¿¡æ¯
          - å›ºä»¶æºç : ${{ env.REPO_URL }}
          - æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - æœ¬æ¬¡ç¼–è¯‘æœ€åæ›´æ–°è®°å½•:
          - ${{ env.VERSION_INFO }}
