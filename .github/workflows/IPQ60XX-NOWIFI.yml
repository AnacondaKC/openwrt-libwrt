# ====================================================================================
#  最终完美版 OpenWrt 编译流程 (v2 - 2025-06-28)
#  已根据你的新文件命名规则，更新了自定义文件路径。
# ====================================================================================
name: Build OpenWrt for IPQ60XX-NOWIFI

on:
  workflow_dispatch: # 允许手动触发
  # schedule:
  #   - cron: '0 19 * * *' # 可根据需要取消注释以启用定时编译

env:
  # 源码信息
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: k6.12-nss

  # 配置文件与自定义文件路径 (已更新为你的新文件名)
  CONFIG_FILE: configs/ipq60xx-nowifi.config
  CUSTOM_FEEDS_CONF: feeds/IPQ60XX-NOWIFI-feeds.txt
  INIT_SETTINGS_SCRIPT: scripts/IPQ60XX-NOWIFI-settings.sh

  # 编译和发布选项
  CACHE_TOOLCHAIN: true
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: IPQ60XX-NOWIFI
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: 1. 环境与空间准备 (Initialization & Maximize Space)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi $(docker images -q) >/dev/null 2>&1
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
        sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* >/dev/null 2>&1
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL https://git.io/depends-ubuntu-2204)
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get -y clean
        sudo timedatectl set-timezone "$TZ"

    - name: 2. 扩展磁盘空间 (Combine Disks)
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        root-reserve-mb: 1024

    - name: 3. 检出工作流仓库 (Checkout Workflow Repo)
      uses: actions/checkout@main

    - name: 4. 克隆OpenWrt源码 (Clone Source Code)
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        echo "OPENWRT_PATH=$PWD/openwrt" >> $GITHUB_ENV
        cd openwrt
        VERSION_INFO=$(git show -s --date=short --format="作者: %an<br/>时间: %cd<br/>内容: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV

    - name: 5. 加载自定义内容并生成最终.config (Load Custom Feeds, Scripts & Config)
      run: |
        # 将自定义源追加到 feeds 配置文件
        if [ -f "$CUSTOM_FEEDS_CONF" ]; then
          cat $CUSTOM_FEEDS_CONF >> ${{ env.OPENWRT_PATH }}/feeds.conf.default
          echo "自定义 Feeds 已加载。"
        fi

        # 将初始化脚本复制到 uci-defaults 目录
        if [ -f "$INIT_SETTINGS_SCRIPT" ]; then
          mkdir -p ${{ env.OPENWRT_PATH }}/files/etc/uci-defaults
          cp $INIT_SETTINGS_SCRIPT ${{ env.OPENWRT_PATH }}/files/etc/uci-defaults/99-init-settings
          echo "初始化脚本已加载。"
        fi
        
        # 加载你的核心编译配置
        cp $CONFIG_FILE ${{ env.OPENWRT_PATH }}/.config
        
        # 更新并安装所有 feeds (包括自定义的)
        cd ${{ env.OPENWRT_PATH }}
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 生成最终的完整 .config
        make defconfig

    - name: 6. 生成环境变量 (Generate Variables)
      run: |
        cd ${{ env.OPENWRT_PATH }}
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F'"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F'"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        CONFIG_HASH=$(sha256sum .config | awk '{print $1}')
        echo "CONFIG_HASH=$CONFIG_HASH" >> $GITHUB_ENV

    - name: 7. 缓存工具链 (Cache Toolchain)
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.CONFIG_HASH }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: 8. 下载DL软件包 (Download DL Package)
      run: |
        cd ${{ env.OPENWRT_PATH }}
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: 9. 开始编译固件 (Compile Firmware)
      id: compile
      run: |
        cd ${{ env.OPENWRT_PATH }}
        echo "开始 $(nproc) 线程编译..."
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: 10. 整理文件用于发布 (Organize Files for Release)
      if: steps.compile.outputs.status == 'success'
      run: |
        FIRMWARE_DIR="${{ env.OPENWRT_PATH }}/bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}"
        echo "FIRMWARE_PATH=$FIRMWARE_DIR" >> $GITHUB_ENV
        cd $FIRMWARE_DIR
        cp ${{ env.OPENWRT_PATH }}/.config build.config
        rm -rf packages feeds.buildinfo version.buildinfo sha256sums

    - name: 11. 发布固件到Release (Upload Firmware To Release)
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
          ### 📒 固件信息
          - 平台: `${{ env.FIRMWARE_TAG }}`
          - 内核: 6.6 (基于LiBwrt)
          - 特性: 无WIFI, 有线NSS硬件加速
          - 默认地址与密码等由 `init-settings.sh` 脚本定义
          ### 🧊 源码信息
          - 固件源码: ${{ env.REPO_URL }}
          - 源码分支: ${{ env.REPO_BRANCH }}
          - 本次编译最后更新记录:
          - ${{ env.VERSION_INFO }}
