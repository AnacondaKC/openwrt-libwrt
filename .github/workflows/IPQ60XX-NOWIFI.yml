# ====================================================================================
#  最终完美版 OpenWrt 编译流程 (v13 - 使用 oldconfig 解决内核配置问题)
# ====================================================================================
name: Build OpenWrt for IPQ60XX-NOWIFI

on:
  workflow_dispatch:

env:
  # 源码信息
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: k6.12-nss

  # 配置文件与自定义文件路径
  CONFIG_FILE: configs/IPQ60XX-NOWIFI.config
  CUSTOM_FEEDS_CONF: feeds/IPQ60XX-NOWIFI-feeds.txt
  INIT_SETTINGS_SCRIPT: scripts/IPQ60XX-NOWIFI-settings.sh

  # 编译和发布选项
  CACHE_TOOLCHAIN: true
  FIRMWARE_RELEASE: true
  FIRMWARE_TAG: IPQ60XX-NOWIFI
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04

    steps:
    - name: 1. Initialize Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi $(docker images -q) >/dev/null 2>&1
        sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android $AGENT_TOOLSDIRECTORY
        sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* >/dev/null 2>&1
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL https://git.io/depends-ubuntu-2204)
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get -y clean
        sudo timedatectl set-timezone "$TZ"

    - name: 2. Expand Disk Space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        root-reserve-mb: 1024

    - name: 3. Checkout Workflow Repo
      uses: actions/checkout@main

    - name: 4. Clone OpenWrt Source
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        echo "OPENWRT_PATH=$PWD/openwrt" >> $GITHUB_ENV
        cd openwrt
        VERSION_INFO=$(git show -s --date=short --format="作者: %an<br/>时间: %cd<br/>内容: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+' target/linux/qualcommax/Makefile | head -n 1)
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

    - name: 5. Load Custom Content and Prepare Config
      run: |
        # 使用你的 feeds 文件直接覆盖默认的 feeds 配置文件
        if [ -f "$CUSTOM_FEEDS_CONF" ]; then
          cp $CUSTOM_FEEDS_CONF ${{ env.OPENWRT_PATH }}/feeds.conf.default
          echo "已使用自定义 Feeds 覆盖默认配置。"
        else
          echo "警告：找不到自定义 Feeds 文件: $CUSTOM_FEEDS_CONF"
        fi

        # 将初始化脚本复制到 uci-defaults 目录
        if [ -f "$INIT_SETTINGS_SCRIPT" ]; then
          mkdir -p ${{ env.OPENWRT_PATH }}/files/etc/uci-defaults
          cp $INIT_SETTINGS_SCRIPT ${{ env.OPENWRT_PATH }}/files/etc/uci-defaults/99-init-settings
          echo "初始化脚本已加载。"
        else
          echo "警告：找不到初始化脚本: $INIT_SETTINGS_SCRIPT"
        fi
        
        # 加载你的核心编译配置
        if [ -f "$CONFIG_FILE" ]; then
          cp $CONFIG_FILE ${{ env.OPENWRT_PATH }}/.config
          echo "核心配置文件已加载。"
        else
          echo "致命错误：找不到核心配置文件: $CONFIG_FILE"
          exit 1
        fi
        
        # 更新并安装所有 feeds (包括自定义的)
        cd ${{ env.OPENWRT_PATH }}
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 生成最终的完整 .config
        make defconfig

    - name: 6. Generate Environment Variables
      run: |
        cd ${{ env.OPENWRT_PATH }}
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        DEVICE_TARGET=$(grep CONFIG_TARGET_BOARD .config | awk -F'"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        DEVICE_SUBTARGET=$(grep CONFIG_TARGET_SUBTARGET .config | awk -F'"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        CONFIG_HASH=$(sha256sum .config | awk '{print $1}')
        echo "CONFIG_HASH=$CONFIG_HASH" >> $GITHUB_ENV

    - name: 7. Cache Toolchain
      if: env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false
        mixkey: ${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.CONFIG_HASH }}
        prefix: ${{ env.OPENWRT_PATH }}

    - name: 8. Download DL Packages
      run: |
        cd ${{ env.OPENWRT_PATH }}
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: 9. Compile Firmware
      id: compile
      run: |
        cd ${{ env.OPENWRT_PATH }}
        # 使用 make oldconfig 非交互地更新内核配置，解决配置不同步的问题
        make oldconfig
        echo "Compiling with $(nproc) threads..."
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: 10. Organize Files for Release
      if: steps.compile.outputs.status == 'success'
      run: |
        FIRMWARE_DIR="${{ env.OPENWRT_PATH }}/bin/targets/${{ env.DEVICE_TARGET }}/${{ env.DEVICE_SUBTARGET }}"
        echo "FIRMWARE_PATH=$FIRMWARE_DIR" >> $GITHUB_ENV
        cd $FIRMWARE_DIR
        cp ${{ env.OPENWRT_PATH }}/.config build.config
        rm -rf packages feeds.buildinfo version.buildinfo sha256sums

    - name: 11. Upload Firmware to Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: R${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
          ### Firmware Details
          - Platform: `${{ env.FIRMWARE_TAG }}`
          - Kernel: ${{ env.VERSION_KERNEL }}
          - Features: No-WIFI, NSS hardware acceleration for wired connections.
          - Default IP and password are set by the `init-settings.sh` script.
          ### Source Code Info
          - Firmware Source: ${{ env.REPO_URL }}
          - Source Branch: ${{ env.REPO_BRANCH }}
          - Last commit details for this build:
          - ${{ env.VERSION_INFO }}
